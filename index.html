<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Budget v2</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
  
  <link rel="apple-touch-icon" href="icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-color: #FDF5E6;
      --primary-pink: #FFC0CB;
      --btn-pink: #FFB6C1;
      --debt-red: #E57373;
      --trend-green: #AFB42B;
      --text-color: #000;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: env(safe-area-inset-top) 20px 100px 20px; 
      color: var(--text-color);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    h2 { text-transform: uppercase; font-weight: 800; text-align: center; margin-bottom: 25px; letter-spacing: 1px; font-size: 22px; }
    label { font-weight: 600; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 8px; margin-top: 15px; text-align: center; }

    input, select {
      width: 100%;
      padding: 15px;
      border: 2px solid #000;
      border-radius: 50px;
      background: #FFF;
      font-size: 16px;
      text-align: center;
      font-family: inherit;
      outline: none;
      box-sizing: border-box;
      -webkit-appearance: none;
    }

    .save-btn {
      background-color: var(--btn-pink);
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-weight: 800;
      text-transform: uppercase;
      margin: 25px auto;
      display: block;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      width: 60%;
    }
    .save-btn:active { transform: scale(0.98); }

    /* --- NEW CUSTOM IOS SWITCH --- */
    .switch-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-top: 30px; /* More space */
      cursor: pointer;
    }
    
    .switch-bg {
      width: 55px;
      height: 32px;
      background-color: #DDD; /* Gray when off */
      border-radius: 30px;
      position: relative;
      transition: background-color 0.3s ease;
      border: 2px solid #000; /* Matches app style */
    }

    .switch-circle {
      width: 26px;
      height: 26px;
      background-color: #FFF;
      border-radius: 50%;
      position: absolute;
      top: 3px;
      left: 3px;
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      border: 1px solid #000;
    }

    .switch-label {
      font-size: 12px; 
      font-weight: 800;
      text-transform: uppercase;
    }

    /* Active State (Added by JS) */
    .switch-wrapper.active .switch-bg {
      background-color: var(--trend-green);
    }
    .switch-wrapper.active .switch-circle {
      transform: translateX(23px);
    }
    /* ----------------------------- */

    /* NAV BAR */
    .nav-bar {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 5px;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      width: 90%;
      max-width: 400px;
      box-sizing: border-box;
      backdrop-filter: blur(10px);
    }

    .nav-item {
      font-size: 9px;
      font-weight: 800;
      text-transform: uppercase;
      padding: 12px 0;
      border-radius: 40px;
      background: var(--btn-pink);
      border: none;
      cursor: pointer;
      text-align: center;
      white-space: nowrap;
    }
    .nav-item.active { background: #000; color: #FFF; }

    /* SCREENS */
    .screen { display: none; max-width: 400px; margin: 0 auto; }
    .screen.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* HISTORY & CHARTS */
    .chart-row { margin-bottom: 15px; }
    .bar-container { display: flex; align-items: center; gap: 8px; }
    .bar { height: 35px; border-radius: 0 5px 5px 0; min-width: 5px; transition: width 0.5s; }
    .bar-pink { background-color: #FF69B4; }
    .bar-green { background-color: var(--trend-green); }
    .bar-label { font-size: 11px; font-weight: 800; min-width: 80px; }
    .bar-val { font-size: 11px; font-style: italic; }

    .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 800; user-select: none; }
    
    .history-item { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px; padding: 12px 0; border-bottom: 1px solid #ccc; font-size: 13px; align-items: center; }
    .hist-amt { font-weight: 800; }
    .hist-desc { color: #555; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
    .hist-cat { text-align: right; text-transform: uppercase; font-size: 9px; font-weight: 600; letter-spacing: 0.5px; }

    .progress-chart { display: flex; align-items: flex-end; justify-content: center; height: 140px; gap: 20px; margin-bottom: 20px; border-bottom: 3px solid #000; padding-bottom: 0; }
    .p-bar { width: 70px; transition: height 0.5s ease; position: relative; border-radius: 5px 5px 0 0; }
    .p-bar.savings { background-color: var(--primary-pink); }
    .p-bar.debt { background-color: var(--debt-red); }
    .p-label { position: absolute; top: -25px; left: 0; right: 0; text-align: center; font-weight: 800; font-size: 12px; }

  </style>
</head>
<body>

  <div id="screen-spending" class="screen active">
    <h2>Enter a Transaction</h2>
    <label>Amount</label>
    <input type="number" id="amt" placeholder="$0.00" inputmode="decimal">
    
    <label>Description</label>
    <input type="text" id="desc" placeholder="e.g. Tacos">
    
    <label>Category</label>
    <select id="cat"><option>Loading...</option></select>

    <div class="switch-wrapper" id="balance-toggle" onclick="toggleSwitch()">
      <div class="switch-bg">
        <div class="switch-circle"></div>
      </div>
      <div class="switch-label">Did you check your balance?</div>
    </div>

    <button class="save-btn" onclick="submitTransaction()">Save</button>
  </div>

  <div id="screen-progress" class="screen">
    <h2>Progress to Freedom</h2>
    <div class="progress-chart">
      <div class="p-bar savings" id="vis-savings" style="height: 1%"><div class="p-label" id="lbl-savings">$0</div></div>
      <div class="p-bar debt" id="vis-debt" style="height: 1%"><div class="p-label" id="lbl-debt">$0</div></div>
    </div>
    <label>Savings</label>
    <input type="number" id="inp-savings" placeholder="$0" inputmode="decimal">
    <label>Debt</label>
    <input type="number" id="inp-debt" placeholder="$0" inputmode="decimal">
    <button class="save-btn" onclick="submitProgress()">Save Update</button>
  </div>

  <div id="screen-history" class="screen">
    <h2>History</h2>
    <div class="month-nav">
      <span onclick="changeMonth(-1)" style="cursor:pointer; padding: 10px;">&#8592;</span>
      <span id="hist-month-label">LOADING...</span>
      <span onclick="changeMonth(1)" style="cursor:pointer; padding: 10px;">&#8594;</span>
    </div>
    <div id="history-list"></div>
  </div>

  <div id="screen-trends" class="screen">
    <h2>Trends</h2>
    <div class="month-nav">
      <span onclick="changeMonth(-1)" style="cursor:pointer; padding: 10px;">&#8592;</span>
      <span id="trend-month-label">LOADING...</span>
      <span onclick="changeMonth(1)" style="cursor:pointer; padding: 10px;">&#8594;</span>
    </div>
    <div id="trends-list"></div>
  </div>

  <div class="nav-bar">
    <button class="nav-item active" onclick="nav('spending', this)">Spending</button>
    <button class="nav-item" onclick="nav('progress', this)">Progress</button>
    <button class="nav-item" onclick="nav('history', this)">History</button>
    <button class="nav-item" onclick="nav('trends', this)">Trends</button>
  </div>

  <script>
    // ******************************************************
    // PASTE YOUR GOOGLE DEPLOYMENT URL HERE:
    const API_URL = "https://script.google.com/macros/s/AKfycbw0rIxBGCraBV2umYjbkbL-V5gI6zoZAky1gXYO7V0tIpjf1Uyqy2Qk4OX5bm6fSzu8aw/exec";
    // ******************************************************

    let currentMonthOffset = 0;
    let appData = {};

    window.onload = function() {
      fetchData();
    };

    function nav(screenId, btn) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('screen-' + screenId).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if(screenId === 'spending' && !document.getElementById('cat').value) fetchData();
    }

    // --- NEW TOGGLE FUNCTION ---
    function toggleSwitch() {
      const el = document.getElementById('balance-toggle');
      el.classList.toggle('active');
      // Minimal vibration for feedback if supported
      if(navigator.vibrate) navigator.vibrate(10);
    }

    async function fetchData() {
      if(API_URL.includes("PASTE")) return alert("Please update the API_URL in index.html!");
      
      const payload = { action: "getData", monthOffset: currentMonthOffset };
      
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        appData = data;
        renderAll();
      } catch(e) {
        // Silent error
      }
    }

    function renderAll() {
      // Categories
      const catSel = document.getElementById('cat');
      if (catSel.options.length <= 1) {
        catSel.innerHTML = "<option value='' disabled selected>Select...</option>";
        appData.categories.forEach(c => {
          let opt = document.createElement('option');
          opt.value = c; opt.innerText = c;
          catSel.appendChild(opt);
        });
      }

      // Progress
      const s = appData.progress.savings; 
      const d = appData.progress.debt;
      document.getElementById('lbl-savings').innerText = "$" + s;
      document.getElementById('lbl-debt').innerText = "$" + d;
      document.getElementById('inp-savings').value = s;
      document.getElementById('inp-debt').value = d;
      const max = Math.max(s, d, 1000);
      document.getElementById('vis-savings').style.height = (s/max*100) + "%";
      document.getElementById('vis-debt').style.height = (d/max*100) + "%";

      // Month Labels
      document.getElementById('hist-month-label').innerText = appData.monthLabel;
      document.getElementById('trend-month-label').innerText = appData.monthLabel;

      // History
      const histDiv = document.getElementById('history-list');
      histDiv.innerHTML = "";
      if(appData.history.length === 0) histDiv.innerHTML = "<div style='text-align:center;padding:20px;color:#999'>No transactions</div>";
      
      appData.history.forEach(t => {
        const eyeIcon = (t.checkedBalance === true || t.checkedBalance === "true") ? "üëÅÔ∏è " : "";
        histDiv.innerHTML += `
          <div class="history-item">
            <div class="hist-amt">$${t.amount}</div>
            <div class="hist-desc">${eyeIcon} ${t.description}</div>
            <div class="hist-cat">${t.category}</div>
          </div>`;
      });

      // Trends
      const trendsDiv = document.getElementById('trends-list');
      trendsDiv.innerHTML = "";
      const cats = Object.keys(appData.summary);
      if(cats.length === 0) trendsDiv.innerHTML = "<div style='text-align:center;padding:20px;color:#999'>No spending yet</div>";
      let maxVal = 0;
      cats.forEach(c => maxVal = Math.max(maxVal, appData.summary[c]));
      cats.forEach((c, i) => {
        const val = appData.summary[c];
        const w = (val/maxVal)*100;
        const color = i%2===0 ? "bar-pink" : "bar-green";
        trendsDiv.innerHTML += `
          <div class="chart-row">
            <div class="bar-label">${c}</div>
            <div class="bar-container">
              <div class="bar ${color}" style="width:${w}%"></div>
              <div class="bar-val">$${val}</div>
            </div>
          </div>`;
      });
    }

    async function submitTransaction() {
      const amt = document.getElementById('amt').value;
      const cat = document.getElementById('cat').value;
      const desc = document.getElementById('desc').value;
      
      // READ CUSTOM TOGGLE STATE
      const toggleEl = document.getElementById('balance-toggle');
      const checked = toggleEl.classList.contains('active');

      if (!amt || !cat) return alert("Missing info!");

      const btn = document.querySelector('#screen-spending .save-btn');
      btn.innerText = "Saving...";
      
      const payload = {
        action: "saveTransaction",
        data: {
          date: new Date().toISOString(),
          amount: amt,
          category: cat,
          description: desc,
          checkedBalance: checked
        }
      };
      
      await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      
      btn.innerText = "SAVE";
      document.getElementById('amt').value = "";
      document.getElementById('desc').value = "";
      
      // Reset Toggle
      toggleEl.classList.remove('active');
      
      alert("Saved!");
      fetchData(); 
    }

    async function submitProgress() {
      const s = document.getElementById('inp-savings').value;
      const d = document.getElementById('inp-debt').value;
      const btn = document.querySelector('#screen-progress .save-btn');
      btn.innerText = "Saving...";
      
      await fetch(API_URL, { 
        method: "POST", 
        body: JSON.stringify({ action: "saveProgress", savings: s, debt: d }) 
      });
      
      btn.innerText = "SAVE UPDATE";
      alert("Updated!");
      fetchData();
    }

    function changeMonth(dir) {
      currentMonthOffset += dir;
      document.getElementById('hist-month-label').innerText = "LOADING...";
      document.getElementById('trend-month-label').innerText = "LOADING...";
      fetchData();
    }
  </script>
</body>
</html>
